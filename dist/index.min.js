!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("chess.js")):"function"==typeof define&&define.amd?define(["exports","chess.js"],n):n((t="undefined"!=typeof globalThis?globalThis:t||self).ChessKMAPS={},t.Chess)}(this,function(t,n){"use strict";const e=t=>Math.max(0,Math.min(1,t));function o(t,n){const o=t.board();let r=null;for(let t=0;t<8;t++)for(let e=0;e<8;e++){const f=o[t][e];"k"===f?.type&&f.color===n&&(r={file:e,rank:8-t})}if(!r)return.5;let f=0;const i="w"===n?r.rank+1:r.rank-1;let c=0;for(let e=-1;e<=1;e++){const o=Math.max(0,Math.min(7,r.file+e)),f=`${String.fromCharCode(97+o)}${i}`,s=t.get(f);"p"===s?.type&&s.color===n&&c++}const s=c/3;f+=.45*s;const u=`${String.fromCharCode(97+r.file)}${r.rank}`,l=("w"===n?["g1","c1"]:["g8","c8"]).includes(u);let a=.3*("w"===n?1-(r.rank-1)/7:1-(8-r.rank)/7);l&&s>=.66&&(a=.35),f+=a;let h=0;for(let n=-1;n<=1;n++)for(let e=-1;e<=1;e++){if(0===n&&0===e)continue;const o=r.rank+n,f=r.file+e;if(o<1||o>8||f<0||f>7)continue;const i=`${String.fromCharCode(97+f)}${o}`;t.get(i)||h++}f+=h/8*.05;const d="w"===n?"b":"w";let w=0;for(let n=-3;n<=3;n++)for(let e=-3;e<=3;e++){if(0===n&&0===e)continue;const o=r.rank+n,f=r.file+e;if(o<1||o>8||f<0||f>7)continue;const i=`${String.fromCharCode(97+f)}${o}`,c=t.get(i);if(c?.color===d){w+=({q:3,r:2,b:1.5,n:1.2,p:.8}[c.type]||1)/(Math.abs(n)+Math.abs(e))}}f-=Math.min(w/10,.25);const p=e(f);return e(.7*p+.3*p*p)}function r(t,o){const r=t.fen().split(" ");r[1]=o;const f=new n.Chess(r.join(" ")).moves({verbose:!0}).filter(t=>"p"!==t.piece).length;let i=Math.min(f/40,1);return t.board().forEach((t,n)=>t.forEach((t,e)=>{if(!t||t.color!==o||"p"===t.type)return;(function(t){const n=t.charCodeAt(0)-97,e=parseInt(t[1],10)-1;return n>=3&&n<=4&&e>=3&&e<=4})(`${String.fromCharCode(97+e)}${8-n}`)&&["n","b"].includes(t.type)&&(i+=.1)})),e(i)}function f(t,n){return`${String.fromCharCode(97+t)}${n}`}function i(t,n){const e=[];return t.board().forEach((t,o)=>{const r=8-o;t.forEach((t,o)=>{"p"===t?.type&&t.color===n&&e.push({file:o,rank:r,square:f(o,r)})})}),e}function c(t,n){return i(t,"w"===n?"b":"w")}function s(t,n){return Array.from(new Set(i(t,n).map(t=>t.file))).sort((t,n)=>t-n)}function u(t){return"w"===t?1:-1}function l(t){return"w"===t?"b":"w"}function a(t){return[1,-1].map("w"===t?t=>({df:t,dr:1}):t=>({df:t,dr:-1}))}function h(t,n){return t>=0&&t<=7&&n>=1&&n<=8}function d(t,n,e,o){if(!h(e,o))return!1;const r=f(e,o),i=t.get(r);return"p"===i?.type&&i.color===n}function w(t,n){const e=i(t,n),o=new Set(s(t,n));let r=0;for(const t of e){const n=t.file-1,e=t.file+1,f=o.has(n),i=o.has(e);f||i||r++}return r}function p(t,n){const e=i(t,n);function o(n){const e=new Set;for(const o of i(t,n)){const t=a(n);for(const{df:n,dr:r}of t){const t=o.file+n,i=o.rank+r;h(t,i)&&e.add(f(t,i))}}return e}const r=o(n),c=o(l(n));function s(e,o){for(const r of[-1,1]){const f=e+r;if(!(f<0||f>7))if("w"===n){for(let e=o-1;e>=2;e--)if(d(t,n,f,e))return!0}else for(let e=o+1;e<=7;e++)if(d(t,n,f,e))return!0}return!1}let w=0;for(const t of e){const e=f(t.file,t.rank+u(n));if(!h(t.file,t.rank+u(n)))continue;if(s(t.file,t.rank))continue;if(r.has(e))continue;c.has(e)&&w++}return w}function g(t,n){const e=i(t,n),o=new Set;function r(t,e){const o=e.file-t.file,r=e.rank-t.rank,f=u(n);return 1===Math.abs(o)&&r===f}const f=[];for(const t of e){if(o.has(t.square))continue;const n=[t];o.add(t.square);let i=!0;for(;i;){i=!1;for(const t of e)o.has(t.square)||r(n[n.length-1],t)&&(n.push(t),o.add(t.square),i=!0)}n.length>1&&f.push(n)}return f}function k(t){const n=new Set(s(t,"w")),e=new Set(s(t,"b")),o=new Set,r=new Set,f={w:new Set,b:new Set};for(let t=0;t<8;t++){const i=n.has(t),c=e.has(t);i||c?i&&c?r.add(t):c&&!i?f.w.add(t):i&&!c&&f.b.add(t):o.add(t)}return{open:o,halfOpen:f,closed:r}}function m(t,n){const e=i(t,n),o=c(t,n),r=e.filter(t=>t.file<=2).length,f=e.filter(t=>t.file>=5).length;return{queensideMajority:r>o.filter(t=>t.file<=2).length,kingsideMajority:f>o.filter(t=>t.file>=5).length}}function b(t,n){const e=i(t,n);let o=0;for(const r of e){if(!("w"===n?r.rank>=6:r.rank<=3))continue;let e=!1;for(const o of[-1,1]){const f=r.file+o;if(!(f<0||f>7)){if("w"===n){for(let o=r.rank-1;o>=2;o--)if(d(t,n,f,o)){e=!0;break}}else for(let o=r.rank+1;o<=7;o++)if(d(t,n,f,o)){e=!0;break}if(e)break}}e||o++}return o}const M=new Map;function y(t){return`P:${i(t,"w").map(t=>t.square).sort().join(",")}|${i(t,"b").map(t=>t.square).sort().join(",")}`}function S(t){const n=y(t);return M.get(n)}function C(t,n){const o=S(t);if(o&&"number"==typeof o[n])return e(o[n]);const r=function(t,n){return i(t,n).length}(t,n)||1,C=w(t,n),q=function(t,n){const e=i(t,n),o=new Map;for(const t of e)o.set(t.file,(o.get(t.file)||0)+1);let r=0;for(const[,t]of o)t>=2&&(r+=t-1);return r}(t,n),$=function(t,n){const e=s(t,n);if(0===e.length)return 0;let o=1;for(let t=1;t<e.length;t++)e[t]!==e[t-1]+1&&o++;return o}(t,n),j=p(t,n),E=b(t,n),v=function(t,n){const e=i(t,n).filter(t=>3===t.file||4===t.file),o=new Map;for(const t of e)o.set(t.file,(o.get(t.file)||0)+1);let r=0;for(const[,t]of o)t>=2&&(r+=t-1);return r}(t,n),x=function(t,n){const e=i(t,n),o=c(t,n),r=new Map;for(const t of o)r.has(t.file)||r.set(t.file,[]),r.get(t.file).push(t.rank);for(const t of r.values())t.sort((t,n)=>t-n);function f(t,e){const o=r.get(t);return!(!o||0===o.length)&&("w"===n?o.some(t=>t>e):o.some(t=>t<e))}const s=new Map;for(const t of e)s.has(t.file)||s.set(t.file,[]),s.get(t.file).push(t.rank);for(const t of s.values())t.sort((t,n)=>t-n);function u(t,e){const o=s.get(t);return!!o&&("w"===n?o.some(t=>t>e):o.some(t=>t<e))}let l=0;for(const t of e)[t.file,t.file-1,t.file+1].filter(t=>t>=0&&t<=7).some(n=>f(n,t.rank))||u(t.file,t.rank)||l++;return l}(t,n),A=function(t,n){const e=i(t,n),o=k(t).halfOpen[n];function r(e,o){const r=o+u(n);if(!h(e,r))return!0;const i=f(e,r);return!!t.get(i)}function c(e,o){for(const r of[-1,1]){const f=e+r;if(!(f<0||f>7))if("w"===n){for(let e=o-1;e>=2;e--)if(d(t,n,f,e))return!0}else for(let e=o+1;e<=7;e++)if(d(t,n,f,e))return!0}return!1}let s=0;for(const t of e)o.has(t.file)&&(r(t.file,t.rank)||c(t.file,t.rank)&&s++);return s}(t,n),B=function(t,n){return g(t,n).length}(t,n),W=function(t,n){const e=g(t,n),o=[];for(const t of e)o.push(t[0]);return o}(t,n).length,P=function(t,n){const e=i(t,n);let o=0;for(const r of e)for(const{df:e,dr:i}of a(n)){const c=r.file+e,s=r.rank+i;if(!h(c,s))continue;const u=f(c,s),a=t.get(u);"p"===a?.type&&a.color===l(n)&&o++}return o}(t,n),K=function(t){const n=i(t,"w"),e=new Map;for(const n of i(t,"b"))e.has(n.file)||e.set(n.file,new Set),e.get(n.file).add(n.rank);let o=0;for(const t of n){const n=e.get(t.file);n&&n.has(t.rank+1)&&o++}return o}(t),O=function(t,n){const e=i(t,n),o=new Map;for(const t of e)o.has(t.file)||o.set(t.file,[]),o.get(t.file).push(t.rank);for(const t of o.values())t.sort((t,n)=>t-n);const{halfOpen:r}=k(t),f=r[n];let c=0;for(let t=0;t<7;t++){const e=t+1,r=!!o.get(t),i=!!o.get(e);if(!r||!i)continue;const s=o.get(t),u=o.get(e);if(!("w"===n?s.some(t=>t>=4)&&u.some(t=>t>=4):s.some(t=>t<=5)&&u.some(t=>t<=5)))continue;const l=!(t-1>=0)||f.has(t-1),a=!(e+1<=7)||f.has(e+1);l&&a&&c++}return c}(t,n),z=function(t,n){const e=new Set;function o(e,o){const r=u(n);for(const f of[-1,1]){const i=e-f,c=o-r;if(h(i,c))if("w"===n){for(let e=c;e>=2;e--)if(d(t,n,i,e))return!0}else for(let e=c;e<=7;e++)if(d(t,n,i,e))return!0}return!1}const r="w"===n?[1,2,3,4]:[8,7,6,5];for(const t of r)for(let n=0;n<8;n++)o(n,t)||e.add(f(n,t));return e}(t,n).size,{queensideMajority:I,kingsideMajority:T}=m(t,n),D=function(t,n){const e=m(t,n);return{queensideMinority:!e.queensideMajority,kingsideMinority:!e.kingsideMajority}}(t,n),F=function(t,n){return w(t,n)+p(t,n)+b(t,n)}(t,n),G=(I?.02:0)+(T?.02:0)-(D.queensideMinority?.02:0)-(D.kingsideMinority?.02:0);let H=1-C/r*.4-q/r*.55-j/r*.25-E/r*.2-v/r*.2-Math.max(0,$-1)/4*.1-W/r*.05-F/r*.1-z/8*.1-O/4*.05-K/8*.1+x/r*.4+A/r*.15+B/4*.1+P/r*.05+G;const J=e(H);return function(t,n){const e=y(t);M.set(e,n)}(t,{...S(t)||{},[n]:J}),J}function q(t,o){const r=t.fen().split(" ");r[1]=o;const f=new n.Chess(r.join(" ")),i="w"===o?5:1,c="w"===o?8:4,s=f.moves({verbose:!0}),u=new Set(s.filter(t=>"k"!==t.piece).filter(t=>{const n=parseInt(t.to[1],10);return n>=i&&n<=c}).map(t=>t.to)),l=Math.min(u.size/28,1);let a=0,h=0;const d={p:1,n:.8,b:.8,r:.6,q:.5,k:.2};t.board().forEach((t,n)=>t.forEach((t,e)=>{if(!t||t.color!==o)return;const r=8-n,f="w"===o?r>=5:r<=4,i=d[t.type]||.5;h+=i,f&&(a+=i)}));const w=h>0?a/h:0,p=new Set(["c","d","e","f"]);let g=0,k=0;t.board().forEach((t,n)=>t.forEach((t,e)=>{if(!t||t.color!==o)return;const r=8-n,f=String.fromCharCode(97+e);("w"===o?r>=5:r<=4)&&p.has(f)&&g++,p.has(f)&&k++}));return e(.55*l+.3*w+.15*(k>0?g/k:0))}t.computeKMAPS=function(t){if(!t||"string"!=typeof t)return[];let f;try{f=new n.Chess(t)}catch{return[]}const{whiteMaterialScore:i,blackMaterialScore:c}=function(t){const n={p:1,n:3,b:3,r:5,q:9,k:0};let o=0,r=0;t.board().flat().forEach(t=>{if(!t)return;const e=n[t.type]||0;"w"===t.color?o+=e:r+=e});const f=o-r;return{whiteMaterialScore:e((f+39)/78),blackMaterialScore:e((39-f)/78)}}(f);return[{metric:"Material",White:i,Black:c},{metric:"King Safety",White:o(f,"w"),Black:o(f,"b")},{metric:"Activity",White:r(f,"w"),Black:r(f,"b")},{metric:"Pawn Structure",White:C(f,"w"),Black:C(f,"b")},{metric:"Space",White:q(f,"w"),Black:q(f,"b")}]}});
